<section class="section is-main-section">
  <.breadcrumbs>
    <:breadcrumb label={gettext("Dashboard")} href={~p"/"} />
    <:breadcrumb label={gettext("Invoices")} href={~p"/books/invoices"} />
  </.breadcrumbs>

  <div class="card tile is-child has-table has-mobile-sort-spaced">
    <form class="card-filter" phx-change="filters">
      <div class="field">
        <.link patch={~p"/books/invoices/new"} class="button">
          <div class="icon-text">
            <.icon name="hero-plus-circle" class="mr-2" />
            <span><%= gettext("New Invoice") %></span>
          </div>
        </.link>
      </div>
      <.input
        class=""
        type="select"
        name="term-and-year"
        options={terms_and_years()}
        prompt={gettext("All")}
        value={@term_and_year}
      />
      <.input
        class=""
        type="select"
        name="status"
        options={invoice_statuses()}
        prompt={gettext("All")}
        value={@invoice_status}
      />
      <.input
        :if={@filters != []}
        class=""
        type="select"
        name="filter"
        options={@filters}
        prompt=""
        value={@filter}
      />
      <div :if={@filters != []} class="field">
        <.link
          class="button is-info"
          {if(@filter == "",
            do: [disabled: "disabled"],
            else: [
              href: ~p"/books/invoices/run/#{@filter}?#{filters(assigns)}",
              target: "_blank"
            ])}
        >
          <div class="icon-text">
            <.icon name="hero-arrow-down-tray" class="mr-2" />
            <span><%= gettext("Download") %></span>
          </div>
        </.link>
      </div>
    </form>
    <div class="card-content">
      <div class="b-table has-pagination">
        <div class="table-wrapper has-mobile-cards">
          <.table
            id="books_invoices"
            rows={@streams.books_invoices}
            row_click={fn {_id, invoice} -> JS.navigate(~p"/books/invoices/#{invoice}") end}
          >
            <:action :let={{_id, invoice}}>
              <.link class="button is-info is-light" href={~p"/books/invoices/#{invoice}"} target="_blank">
                <.icon name="hero-document-currency-euro" class="mr-2" />
              </.link>
            </:action>
            <:action :let={{_id, invoice}}>
              <.link
                class="button is-light"
                patch={~p"/books/invoices/#{invoice}/duplicate"}
                title={gettext("Duplicate")}
              >
                <.icon name="hero-document-duplicate" class="mr-2" />
              </.link>
            </:action>
            <:action :let={{_id, invoice}}>
              <.link
                class="button is-light"
                patch={~p"/books/invoices/#{invoice}/edit"}
                title={gettext("Edit")}
              >
                <.icon name="hero-pencil" class="mr-2" />
              </.link>
            </:action>
            <:action :let={{id, invoice}}>
              <.link
                phx-click={JS.push("delete", value: %{id: invoice.id, dom_id: id})}
                class="button is-danger is-light"
                data-confirm={gettext("Are you sure?")}
                title={gettext("Delete")}
              >
                <.icon name="hero-trash" class="mr-2" />
              </.link>
            </:action>
            <:col :let={{_id, invoice}} label={gettext("Invoice Number")}>
              <%= invoice.invoice_number %>
            </:col>
            <:col :let={{_id, invoice}} label={gettext("Invoice Date")}>
              <%= invoice.invoice_date %>
            </:col>
            <:col :let={{_id, invoice}} label={gettext("Name / Client")}>
              <%= if name = invoice.name do %>
                <strong><%= name %></strong> <br /><%= get_client(invoice) %>
              <% else %>
                <%= get_client(invoice) %>
              <% end %>
            </:col>
            <:col :let={{_id, invoice}} label={gettext("Paid?")} class="has-text-centered">
              <%= if invoice.paid_date do %>
                <.icon name="hero-check" class="mr-2 text-success text-sm" />
              <% else %>
                <.icon name="hero-x-mark" class="mr-2 text-error text-sm" />
              <% end %>
            </:col>
            <:col :let={{_id, invoice}} label={gettext("Subtotal")} class="has-text-right">
              {Money.new(invoice.subtotal_price, invoice.currency)}
            </:col>
            <:col :let={{_id, invoice}} label={gettext("Tax")} class="has-text-right">
              {Money.new(invoice.tax_price, invoice.currency)}
            </:col>
            <:col :let={{_id, invoice}} label={gettext("Total")} class="has-text-right">
              {Money.new(invoice.total_price, invoice.currency)}
            </:col>
          </.table>
        </div>
      </div>
    </div>
  </div>
</section>

<.modal
  :if={@live_action in [:new, :edit, :duplicate]}
  id="invoice-modal"
  show
  on_cancel={JS.patch(~p"/books/invoices")}
>
  <.live_component
    module={ContaWeb.InvoiceLive.FormComponent}
    id={@set_invoice.invoice_number || :new}
    title={@page_title}
    action={@live_action}
    set_invoice={@set_invoice}
    company_nif={@company_nif}
    patch={~p"/books/invoices"}
  />
</.modal>
